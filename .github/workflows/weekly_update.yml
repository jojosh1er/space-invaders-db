name: ðŸ›¸ Weekly Invaders Update

on:
  # Chaque dimanche Ã  6h UTC
  schedule:
    - cron: '0 6 * * 0'
  
  # DÃ©clenchement manuel possible
  workflow_dispatch:
    inputs:
      city:
        description: 'Ville spÃ©cifique Ã  scraper (vide = toutes)'
        required: false
        default: ''
      verbose:
        description: 'Mode verbeux'
        required: false
        type: boolean
        default: false
      skip_geolocate:
        description: 'Passer l''Ã©tape de gÃ©olocalisation'
        required: false
        type: boolean
        default: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 150  # 2h30 max (scraping + gÃ©olocalisation)
    
    permissions:
      contents: write  # NÃ©cessaire pour push
      issues: write    # NÃ©cessaire pour fermer les issues
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install -r scripts/requirements.txt
          playwright install chromium
          playwright install-deps
          # DÃ©pendances gÃ©olocalisation (OCR + Vision)
          pip install pytesseract anthropic Pillow
          sudo apt-get update && sudo apt-get install -y tesseract-ocr tesseract-ocr-fra
      
      - name: ðŸ” Scrape & process issues
        env:
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          ARGS="--headless --add-missing"
          
          # Ville spÃ©cifique si demandÃ©e
          if [ -n "${{ github.event.inputs.city }}" ]; then
            ARGS="$ARGS --city ${{ github.event.inputs.city }}"
          fi
          
          # Mode verbeux
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            ARGS="$ARGS --verbose"
          fi
          
          python scripts/update_from_spotter.py $ARGS
      
      - name: ðŸ†• DÃ©tecter les nouveaux invaders
        id: detect_new
        run: |
          # Compter les invaders ajoutÃ©s (geo_source=city_center ou location_unknown=true)
          NEW_COUNT=$(python3 -c "
          import json
          with open('data/invaders_master.json') as f:
              db = json.load(f)
          new_invaders = [inv for inv in db 
                         if inv.get('missing_from_github') 
                         and inv.get('geo_source') == 'city_center'
                         and not inv.get('geo_search_exhausted')]
          print(len(new_invaders))
          ")
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ†• $NEW_COUNT nouveaux invaders Ã  gÃ©olocaliser"
      
      - name: ðŸ“ GÃ©olocaliser les nouveaux invaders
        if: steps.detect_new.outputs.new_count != '0' && github.event.inputs.skip_geolocate != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ARGS="--from-master --pnote-url --no-browser"
          
          # Ville spÃ©cifique si demandÃ©e
          if [ -n "${{ github.event.inputs.city }}" ]; then
            ARGS="$ARGS --city ${{ github.event.inputs.city }}"
          fi
          
          # Mode verbeux
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            ARGS="$ARGS --verbose"
          fi
          
          python scripts/geolocate_missing.py $ARGS
          
          # Fusionner les rÃ©sultats dans le master
          if [ -f "data/invaders_geolocated.json" ]; then
            python scripts/geolocate_missing.py --merge data/invaders_geolocated.json
          fi
      
      - name: ðŸ“Š Afficher les stats
        run: |
          python3 -c "
          import json
          with open('data/metadata.json') as f:
              m = json.load(f)
          print(f\"Total: {m['total_invaders']} invaders, {m['total_cities']} villes\")
          print(f\"Statuts: {m['status_counts']}\")
          
          # Stats gÃ©oloc
          with open('data/invaders_master.json') as f:
              db = json.load(f)
          exhausted = sum(1 for inv in db if inv.get('geo_search_exhausted'))
          city_center = sum(1 for inv in db if inv.get('geo_source') == 'city_center')
          unknown = sum(1 for inv in db if inv.get('location_unknown'))
          print(f'GÃ©oloc: {city_center} au centre-ville, {exhausted} recherche Ã©puisÃ©e, {unknown} inconnus')
          "
      
      - name: ðŸ“¤ Commit & Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Space Invaders Bot ðŸ›¸"
          
          # VÃ©rifier s'il y a des changements
          if git diff --quiet data/; then
            echo "âœ… Aucun changement dÃ©tectÃ©" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Stats
          TOTAL=$(python3 -c "import json; print(json.load(open('data/metadata.json'))['total_invaders'])")
          
          # GÃ©nÃ©rer le rÃ©sumÃ©
          python3 -c "
          import json
          from datetime import datetime, timedelta
          cl = json.load(open('data/invaders_changelog.json'))
          cutoff = (datetime.now() - timedelta(hours=3)).isoformat()
          recent = [c for c in cl.get('changes',[]) if c.get('detected_at','') > cutoff]
          m = json.load(open('data/metadata.json'))
          
          # Stats gÃ©oloc
          db = json.load(open('data/invaders_master.json'))
          geolocated = sum(1 for inv in db if inv.get('geo_source') not in (None, 'city_center', 'unknown'))
          exhausted = sum(1 for inv in db if inv.get('geo_search_exhausted'))
          
          lines = []
          lines.append('## ðŸ›¸ Rapport de mise Ã  jour')
          lines.append('')
          lines.append(f'| | |')
          lines.append(f'|---|---|')
          lines.append(f'| **Total invaders** | {m[\"total_invaders\"]} |')
          lines.append(f'| **Villes** | {m[\"total_cities\"]} |')
          lines.append(f'| **Avec coordonnÃ©es** | {m.get(\"with_coordinates\", \"?\")} |')
          lines.append(f'| **GÃ©olocalisÃ©s (prÃ©cis)** | {geolocated} |')
          lines.append(f'| **Recherche Ã©puisÃ©e** | {exhausted} |')
          lines.append(f'| **Changements** | {len(recent)} |')
          lines.append('')
          
          if recent:
              lines.append('### DÃ©tail des changements')
              lines.append('')
              lines.append('| Invader | Ancien statut | Nouveau statut | Source |')
              lines.append('|---------|--------------|----------------|--------|')
              for c in recent[:100]:
                  src = c.get('source', 'spotter')
                  lines.append(f'| {c.get(\"invader_id\",\"?\")} | {c.get(\"old_value\",\"?\")} | {c.get(\"new_value\",\"?\")} | {src} |')
              if len(recent) > 100:
                  lines.append(f'| ... | | {len(recent)-100} autres | |')
          else:
              lines.append('_Aucun changement de statut dÃ©tectÃ©._')
          
          with open('summary.md', 'w') as f:
              f.write('\n'.join(lines))
          print(len(recent))
          " > /tmp/change_count.txt
          
          CHANGES=$(cat /tmp/change_count.txt)
          cat summary.md >> $GITHUB_STEP_SUMMARY
          
          DATE=$(date +"%Y-%m-%d")
          
          git add data/
          git commit -m "ðŸ”„ Auto-update ${DATE} - ${TOTAL} invaders, ${CHANGES} changements"
          git pull --rebase origin main
          git push
